<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NextStep.AI - Your profile</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
        rel="stylesheet">
</head>
<body class="landing-body">
  {% include "navbar.html" %}

  <main class="profile-main">
    <!-- HERO: user + streak -->
    <section class="profile-hero">
      <div class="app-shell profile-hero-inner">
        <div class="profile-hero-left">
          <p class="profile-kicker">Your interview hub</p>
          <h1 class="profile-title">Hi, {{ current_user.username }}</h1>
          <p class="profile-subtitle">
            This is where you can track your daily streak, review recent answers,
            and keep an eye on your custom prep reports and resume reviews.
          </p>
          {% if current_user.email %}
            <p class="profile-email">Logged in as <strong>{{ current_user.email }}</strong></p>
          {% endif %}

          <div class="profile-stat-row">
            <div class="profile-stat">
              <span class="profile-stat-label">Saved answers</span>
              <span class="profile-stat-value">{{ answers|length }}</span>
            </div>
            <div class="profile-stat">
              <span class="profile-stat-label">Prep reports</span>
              <span class="profile-stat-value">{{ prep_reports|length }}</span>
            </div>
            <div class="profile-stat">
              <span class="profile-stat-label">Resume reviews</span>
              <span class="profile-stat-value">{{ resume_reports|length }}</span>
            </div>
          </div>
        </div>

        <div class="profile-hero-right">
          <div class="streak-card">
            <div class="streak-header">
              <span class="streak-label">Daily streak</span>
              <span class="streak-badge">Keep it going ðŸ”¥</span>
            </div>
            <div class="streak-main">
              <div class="streak-current">
                <span class="streak-number">
                  {{ current_user.streak_count or 0 }}
                </span>
                <span class="streak-caption">days in a row</span>
              </div>
              <div class="streak-meta">
                <div class="streak-meta-row">
                  <span>Best streak</span>
                  <span class="streak-meta-value">
                    {{ current_user.longest_streak or 0 }} days
                  </span>
                </div>
                <div class="streak-progress-track">
                  <div class="streak-progress-bar"
                       style="--streak-ratio: {{
                         ((current_user.streak_count or 0) /
                         ((current_user.longest_streak or 1) | float))
                       }};">
                  </div>
                </div>
                <p class="streak-hint">
                  Answer todayâ€™s question to extend your streak.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- BODY GRID: answers + reports -->
    <section class="profile-body">
      <div class="app-shell profile-grid">
        <!-- Recent answers -->
        <section class="profile-card profile-answers-card">
          <header class="profile-card-header">
            <div>
              <h2>Recent answers</h2>
              <p class="profile-card-subtitle">
                Latest {{ answers|length }} saved answers (max 20).
              </p>
            </div>
          </header>

          {% if answers %}
            <ul class="profile-list answers-list">
              {% for ans in answers %}
                <li class="profile-list-item">
                  <div class="profile-list-top-row">
                    <div class="profile-list-meta">
                      <span class="profile-list-source">
                        {{ ans.question_source }}
                      </span>
                      {% if ans.created_at %}
                        <span class="profile-list-dot">â€¢</span>
                        <span class="profile-list-date">
                          {{ ans.created_at.strftime("%Y-%m-%d %H:%M") }}
                        </span>
                      {% endif %}
                    </div>
                    {% if ans.final_score is not none %}
                      <span class="profile-list-final-score">
                        Final: {{ ans.final_score }}
                      </span>
                    {% endif %}
                  </div>

                  <div class="profile-list-question">
                    Q: {{ ans.raw_question_text }}
                  </div>

                  <div class="profile-list-answer">
                    A: {{ ans.answer_text }}
                  </div>

                  <div class="scores profile-list-scores">
                    {% if ans.relevance_score is not none %}
                      <div>
                        Relevance:
                        <span class="score-pill">{{ ans.relevance_score }}</span>
                      </div>
                    {% endif %}
                    {% if ans.confidence_score is not none %}
                      <div>
                        Confidence:
                        <span class="score-pill">{{ ans.confidence_score }}</span>
                      </div>
                    {% endif %}
                  </div>
                  {% if ans.feedback_text %}
                    {# Split into Strengths / Improvements like in result.html #}
                    {% set raw = ans.feedback_text or "" %}
                    {% set parts = raw.split("Improvements:") %}
                    {% set strengths_part = parts[0] %}
                    {% set improvements_part = parts[1] if parts|length > 1 else "" %}

                    {% set strengths_clean = strengths_part.replace("Strengths:", "").strip() %}
                    {% set improvements_clean = improvements_part.strip() %}

                    {% set strengths_items = strengths_clean.split(";") if strengths_clean else [] %}
                    {% set improvements_items = improvements_clean.split(";") if improvements_clean else [] %}

                    <div class="profile-feedback-grid">
                      {% if strengths_items %}
                        <div class="profile-feedback-section profile-feedback-strengths">
                          <h4>Strengths</h4>
                          <ul>
                            {% for item in strengths_items %}
                              {% if item.strip() %}
                                <li>{{ item.strip() }}</li>
                              {% endif %}
                            {% endfor %}
                          </ul>
                        </div>
                      {% endif %}
                      
                      {% if improvements_items %}
                        <div class="profile-feedback-section profile-feedback-improvements">
                          <h4>Improvements</h4>
                          <ul>
                            {% for item in improvements_items %}
                              {% if item.strip() %}
                                <li>{{ item.strip() }}</li>
                              {% endif %}
                            {% endfor %}
                          </ul>
                        </div>
                      {% endif %}
                    </div>
                  
                    {# Fallback: if we somehow could not parse, show raw text #}
                    {% if not strengths_items and not improvements_items %}
                      <p class="profile-list-feedback">
                        {{ ans.feedback_text }}
                      </p>
                    {% endif %}
                  {% endif %}                
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="profile-empty">
              You do not have any answers saved yet.
              Go to the <a href="{{ url_for('index') }}">Home</a> page and practice a question.
            </p>
          {% endif %}
        </section>

        <!-- Prep reports -->
        <section class="profile-card profile-reports-card">
          <header class="profile-card-header">
            <div>
              <h2>Custom prep reports</h2>
              <p class="profile-card-subtitle">
                All the interview guides you have generated with NextStep.AI.
              </p>
            </div>
          </header>

          {% if prep_reports %}
            <ul class="profile-list reports-list">
              {% for r in prep_reports %}
                <li class="profile-list-item">
                  <a
                    href="{{ url_for('view_saved_prep_report', report_id=r.id) }}"
                    class="profile-report-link"
                  >
                    <div class="profile-report-header">
                      <div class="profile-report-title">
                        {{ r.job_title }}
                        {% if r.company_name %}
                          <span class="profile-report-company">Â· {{ r.company_name }}</span>
                        {% endif %}
                      </div>
                      {% if r.created_at %}
                        <span class="profile-report-date">
                          {{ r.created_at.strftime("%Y-%m-%d") }}
                        </span>
                      {% endif %}
                    </div>

                    {% if r.report_json and r.report_json.get("behavioral_practice") %}
                      <p class="profile-report-focus">
                        Behavioral focus:
                        {{ r.report_json["behavioral_practice"].get("title", "") }}
                      </p>
                    {% endif %}

                    <p class="profile-report-hint">
                      Click to reopen this report, review everything, and download it.
                    </p>
                  </a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="profile-empty">
              No custom prep reports yet.
              Try the <a href="{{ url_for('custom_prep') }}">Custom AI Prep</a> page before your next interview.
            </p>
          {% endif %}
        </section>

        <!-- Resume review reports -->
        <section class="profile-card profile-resume-card">
          <header class="profile-card-header">
            <div>
              <h2>Resume reviews</h2>
              <p class="profile-card-subtitle">
                All the resume check reports you have generated with NextStep.AI.
              </p>
            </div>
          </header>

          {% if resume_reports %}
            <ul class="profile-list reports-list">
              {% for r in resume_reports %}
                <li class="profile-list-item">
                  <a
                    href="{{ url_for('view_saved_resume_report', report_id=r.id) }}"
                    class="profile-report-link"
                  >
                    <div class="profile-report-header">
                      <div class="profile-report-title">
                        {% if r.target_role %}
                          {{ r.target_role }}
                        {% else %}
                          Resume review
                        {% endif %}
                        {% if r.target_company %}
                          <span class="profile-report-company">Â· {{ r.target_company }}</span>
                        {% endif %}
                      </div>
                      {% if r.created_at %}
                        <span class="profile-report-date">
                          {{ r.created_at.strftime("%Y-%m-%d") }}
                        </span>
                      {% endif %}
                    </div>

                    {# Safely show summary whether it is a string or an object #}
                    {% if r.report_json and r.report_json.get("summary") %}
                      <p class="profile-report-focus">
                        Summary:
                        {{ r.report_json["summary"] }}
                      </p>
                    {% endif %}

                    <p class="profile-report-hint">
                      Click to reopen this resume review and download it as a PDF.
                    </p>
                  </a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="profile-empty">
              No resume reviews yet.
              Try the <a href="{{ url_for('resume_check') }}">Resume check</a> page to get tailored improvements.
            </p>
          {% endif %}
        </section>
      </div>
    </section>
  </main>

  <footer class="landing-footer">
    <p>Â© {{ current_year or "2025" }} NextStep.AI. All rights reserved.</p>
  </footer>
</body>
</html>
